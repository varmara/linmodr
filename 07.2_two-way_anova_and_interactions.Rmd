---
title: "Дисперсионный анализ, часть 2"
subtitle: "Линейные модели..."
author: "Марина Варфоломеева, Вадим Хайтов"
output:
  beamer_presentation:
    colortheme: beaver
    highlight: tango
    includes:
      in_header: ./includes/header.tex
    pandoc_args:
    - --latex-engine=xelatex
    - -V fontsize=10pt
    - -V lang=russian
    slide_level: 2
    theme: default
    toc: no
institute: "Кафедра Зоологии беспозвоночных, Биологический факультет, СПбГУ"
---

```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
# to render
# rmarkdown::render("10_two-way_anova_and_interactions.Rmd", output_format = "beamer_presentation")
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.show='hold', size='footnotesize', comment="#", warning=FALSE, message=FALSE, dev='cairo_pdf', fig.height=2.5, fig.width=7.7)
# library("extrafont")
```


## Многофакторный дисперсионный анализ

- Модель многофакторного дисперсионного анализа
- Взаимодействие факторов
- Несбалансированные данные, типы сумм квадратов
- Многофакторный дисперсионный анализ в R
- Дисперсионный анализ в матричном виде

### Вы сможете

- Проводить многофакторный дисперсионный анализ и интерпретировать его результаты с учетом взаимодействия факторов

# Данные

## Пример: Удобрение и беспозвоночные

Влияет ли добавление азотных и фосфорных удобрений на беспозвоночных?

Небольшие искуственные субстраты экспонировали в течение разного времени в верхней части сублиторали (Hall et al., 2000).

Зависимая переменная:

- `richness` --- Число видов

Факторы:

- `time` --- срок экспозиции (2, 4 и 6 месяцев)
- `treat` --- удобрения (добавляли или нет)

Планировали сделать 5 повторностей для каждого сочетания факторов

\vskip0pt plus 1filll
\tiny Данные из Quinn, Keough, 2002

## Знакомимся с данными

```{r}
fert <- read.csv(file="data/hall.csv")
str(fert)
# Для удобства названия переменных маленькими буквами
colnames(fert) <- tolower(colnames(fert))
# Время делаем фактором
fert$time <- factor(fert$time)
levels(fert$time)
```

## Пропущенные значения

```{r}
colSums(is.na(x))
```

> - Нет пропущенных значений

## Объемы выборок в группах

```{r}
table(fert$time, fert$treat)
```

> - Группы разного размера

##   Посмотрим на график

```{r}
library(ggplot2)
theme_set(theme_bw())
gg_rich <- ggplot(data = fert, aes(x = time, y = richness, colour = treat)) + 
  stat_summary(geom = "pointrange", fun.data = mean_se)
gg_rich
```

- Вполне возможно, здесь есть гетерогенность дисперсий.

## Преобразовываем данные

Зависимая переменная `richness` -- это счетная величина. Она подчиняется распределению Пуассона (и чем больше ее среднее значение, тем больше дисперсия). 

Правильно было бы воспользоваться обобщенными линейными моделями с Пуассоновским распределением ошибок вместо нормального.

Но пока что мы попробуем преобразовать зависимую переменную, чтобы ее распределение стало больше походить на нормальное. Это может помочь, а может и нет.

```{r}
fert$log_rich <- log10(fert$richness + 1)
```

# Линейные модели с разным числом дискретных предикторов и взаимодействиями

## Линейные модели с разным числом дискретных предикторов

- Два фактора A и B, двухфакторное взаимодействие

$y _{ijk} = \mu + \alpha _i + \beta _j + (\alpha \beta) _{ij} + \epsilon _{ijk}$

<br /><br />

- Три фактора A, B и C, двухфакторные взаимодействия, трехфакторное взаимодействия

$y _{ijkl} = \mu + \alpha _i + \beta _j + \gamma _k + (\alpha \beta) _{ij} + (\alpha \gamma) _{ik} + (\beta \gamma) _{jk} + (\alpha \beta \gamma) _{ijk} + \epsilon _{ijkl}$


\pause

$\alpha$, $\beta$ и $\gamma$ --- это группы коэффициентов, кодирующие соответствующие факторы.

## Что такое взаимодействие дискретных предикторов

Взаимодействие факторов - когда эффект фактора B разный в зависимости от уровней фактора A и наоборот

\columnsbegin
\column{0.5\textwidth}

\includegraphics{images/interaction.png}

\column{0.5\textwidth}

На каких рисунках есть взаимодействие факторов?

\pause

- b, c - нет взаимодействия (эффект фактора B одинаковый для групп по фактору A, линии для разных групп по фактору B на графиках расположены параллельно)
- a, d - есть взаимодействие (эффект фактора B разный для групп по фактору A, на графиках линии для разных групп по фактору B расположены под наклоном).

\columnsend

\vskip0pt plus 1filll
\tiny Рисунок из Logan, 2010, fig.12.2


## Влияют ли главные эффекты и взаимодействие?

\includegraphics{images/interaction1a.png}


\pause

- взаимодействие недостоверно
  - фактор А влияет
  - фактор В влияет

\vskip0pt plus 1filll
\tiny Рисунок из Quinn, Keough, 2002, fig.9.3



## Влияют ли главные эффекты и взаимодействие?

\includegraphics{images/interaction1b.png}

\pause

- взаимодействие достоверно и мешает интерпретировать влияние факторов отдельно:
    - для В2 зависимая переменная возрастает с изменением уровня А
    - для В1 зависимая переменная возрастает только на А2, но не различается на А1 и А3
- если смотреть на главные эффекты, можно сделать неправильные выводы:
    - фактор А влияет, группы А2 и А3 не отличаются
    - фактор В влияет, в группе В2 зависимая переменная больше, чем в В1

\vskip0pt plus 1filll
\tiny Рисунок из Quinn, Keough, 2002, fig.9.3



## Влияют ли главные эффекты и взаимодействие?

\includegraphics{images/interaction1c.png}

\pause

- взаимодействие достоверно и мешает интерпретировать влияние факторов отдельно:
    - на уровне A2 меняется порядок различий уровней фактора B
- если смотреть на главные эффекты, можно сделать неправильные выводы:
    - факторы А и В не влияют

\vskip0pt plus 1filll
\tiny Рисунок из Quinn, Keough, 2002, fig.9.3



## Взаимодействие факторов может маскировать главные эффекты

### Если есть значимое взаимодействие
- главные эффекты обсуждать не имеет смысла  
- пост хок тесты проводятся только для ваимодействия


\includegraphics{images/interaction1.png}

\vskip0pt plus 1filll
\tiny Рисунок из Quinn, Keough, 2002, fig.9.3


# Двухфакторный дисперсионный анализ в матричном виде

## Уравнение линейной модели в параметризации фиктивных переменных (contr.treatment)

$$y _{j} = \beta _0 + \beta _1 x _{1j} + \beta _2 x _{2j} + \cdots + \beta _5 x _{5j} + \varepsilon _{j}$$
В этом примере отклик --- видовое богатство, и два дискретных фактора: `treat` (2 уровня, базовый `control` ), `time` (3 уровня, базовый `2`). Для их кодирования потребуются переменные-индикаторы: $x _{1j}, ..., x _{5j}$ ($j = 1, ..., n$ --- порядковый номер наблюдения).

Коэффициенты:

- $\beta_0$ --- значение отклика в контроле при экспозиции 2 (на базовом уровне обоих факторов)

- $\beta_1$ --- изменение отклика при добавлении удобрений при экспозиции 2 (эффект фактора `treat`)

- $\beta_2$ и $\beta_3$ --- изменение отклика в контроле при экспозициях 4 и 6 соответственно (эффект фактора `time`)

- $\beta_4$ и $\beta_5$ --- изменение отклика при добавлении удобрений при экспозициях 4 и 6 соответственно (эффект взаимодействия факторов)

Остальное все так же как в предыдущем примере с однофакторным анализом.

$$\mathbf{Y} = \mathbf{X} \mathbf{\beta} + \mathbf{\varepsilon}$$

## В параметризации фиктивных переменных

Уровни фактора "удобрения" закодированы с помощью одной переменной-индикатора:

```{r}
contr.treatment(levels(fert$treat))
```

Уровни фактора "время экспозиции" --- с помощью двух переменных-индикаторов:

```{r}
contr.treatment(levels(fert$time))
```

Модельная матрица целиком

```{r}
X_trt <- model.matrix(~ treat*time, data = fert)
X_trt
```

## Для параметризации эффектов (contr.sum) дискретные предикторы кодируются иначе

\small

В модели эффектов (contr.sum) переменные-болванки будут закодированы при помощи -1, 0 и 1, так, чтобы сумма кодов для возможных состояний одной переменной была равна нулю.

Уровни фактора "удобрения" закодированы с помощью одной переменной:

```{r}
contr.sum(levels(fert$treat))
```

Уровни фактора "время экспозиции" --- с помощью двух переменных:

```{r}
contr.sum(levels(fert$time))
```

Модельная матрица целиком

```{r}
X_sum <- model.matrix(~ treat*time, data = fert, 
  contrasts = list(treat = "contr.sum", time = "contr.sum"))
X_sum
```


## Двухфакторный дисперсионный анализ в матричном виде (contr.sum)

Уравнение линейной модели для этого примера (в параметризации эффектов, contr.sum):

$$y _{i} = \beta _0 + \beta _1 x _{1i} + \cdots + \beta _5 x _{5i} + \varepsilon _{i}$$

$x _{1i}, ..., x _{5i}$ --- переменные-индикаторы ($i = 1, ..., n$ --- порядковый номер наблюдения)

- $\beta_0$ - среднее значение отклика по всем данным
- $\beta_1$ - отклонение значений отклика для тритментов от общего среднего (фактор `treat`)
- $\beta_2$, $\beta_3$ - отклонение отклика при разной экспозиции от общего среднего (фактор `time`)
- $\beta_4$, $\beta_5$ - отклонение отклика в тритментах при разных экспозициях от общего среднего (взаимодействие)

# Несбалансированные данные, типы сумм квадратов

## Несбалансированные данные - когда численности в группах по факторам различаются

\columnsbegin

\column{0.5\textwidth}

Например так,

|    | A1 | A2 | A3 |
|----|----|----|----|
| B1 |  5 | 5  |  5 |
| B2 |  5 | 4  |  5 |


\column{0.5\textwidth}

или так,


|    | A1 | A2 | A3 |
|----|----|----|----|
| B1 |  3 | 8  |  4 |
| B2 |  4 | 7  |  4 |

\columnsend

## Проблемы из-за несбалансированности данных

- Оценки средних в разных группах с разным уровнем точности (Underwood 1997)
- ANOVA менее устойчив к отклонениям от условий применимости (особенно от гомогенности дисперсий) при разных размерах групп (Quinn Keough 2002, section 8.3)
- Проблемы с расчетом мощности. Если $\sigma _{\epsilon}^2 > 0$ и размеры выборок разные, то $MS _{x} \over MS _{e}$ не следует F-распределению (Searle et al. 1992).

\vfill
\pause

- Старайтесь _планировать_ группы равной численности!
- Но если не получилось - не страшно:
    - Для фикс. эффектов неравные размеры - проблема при нарушении условий применимости только, если значения доверительной вероятности _p_ близки к выбранному критическому уровню значимости $\alpha$

## Суммы квадратов в многофакторном дисперсионном анализе со взаимодействием

### Если данные сбалансированы, то ...

взаимодействие и эффекты факторов независимы, их суммы квадратов и соответствующие тесты можно посчитать в одном анализе и его результат не будет зависеть от того, в каком порядке мы рассматриваем факторы.

### Если данные несбалансированы, то ...

взаимодействие и эффекты факторов уже не являются полностью независимыми, суммы квадратов для факторов не равны общей сумме квадратов. Если делать все как обычно, результат анализа будет зависеть от порядка включения факторов в модель. (Для вычислений используется регрессионный подход к дисперсионному анализу)



## Если несбалансированные данные, выберите подходящий порядок тестирования гипотез

- SSe и SSab всегда рассчитываются одинаково, вне зависимости от порядка тестирования гипотез и от сбалансированности данных
- SSa, SSb --- есть три способа расчета (суммы квадратов I, II и III типа, терминология пришла из SAS) в зависимости от порядка тестирования значимости факторов

\vfill

- Для сбалансированных дизайнов --- результаты одинаковы
- Для несбалансированных дизайнов рекомендуют __суммы квадратов III типа__ если есть взаимодействие факторов (Maxwell & Delaney 1990, Milliken, Johnson 1984, Searle 1993, Yandell 1997, Glantz, Slinker 2000)

## Порядок тестирования гипотез в дисперсионном анализе

\resizebox{1\textwidth}{!}{
\begin{tabular}{L{0.25\textwidth} C{0.25\textwidth} C{0.25\textwidth} C{0.25\textwidth}}
\hline\noalign{\smallskip}
"Типы сумм квадратов" & I тип & II тип & III тип \\
\hline\noalign{\smallskip}
Название & Последовательный & Без учета взаимодействий высоких порядков & Иерархический \\
Порядок расчета SS & 
SS(A) \linebreak SS(B | A)  \linebreak SS(AB | B, A) & 
SS(A | B) \linebreak SS(B | A) \linebreak SS(AB | B, A) & 
SS(A | B, AB) \linebreak SS(B | A, AB) \linebreak SS(AB | B, A) \\
Величина эффекта зависит от выборки в группе & Да & Да & Нет \\
Результат зависит от порядка включения факторов в модель & Да & Нет & Нет \\
Команда R & aov(), anova() & Anova() (пакет car) &  Anova() (пакет car) \\
\hline\noalign{\smallskip}
\end{tabular}
}

# Многофакторный дисперсионный анализ в R

## Дисперсионный анализ со II типом сумм квадратов

При таком способе, сначала тестируется взаимодействие, затем отдельные факторы в модели без взаимодействия

```{r}
fmod2 <- lm(log_rich ~ treat * time, data = fert)
library(car)
Anova(fmod2, type = "II")
```

## Дисперсионный анализ c III типом сумм квадратов

Опишем процедуру на тот случай, если вдруг вам понадобится воспроизвести в R дисперсионный анализ с III типом сумм квадратов.

При этом способе вначале тестируют взаимодействие, когда все другие факторы есть в модели. Затем тестируют факторы, когда все другие факторы и взаимодействие есть в модели.

__Внимание: при использовании III типа сумм квадратов, нужно обязательно указывать тип контрастов для факторов__ (`contrasts=list(фактор_1 = contr.sum, фактор_2=contr.sum)`).

```{r tidy.opts=list(width.cutoff=40)}
fmod3 <- lm(log_rich ~ treat * time, data = fert, 
            contrasts = list(treat = contr.sum, time = contr.sum))
Anova(fmod3, type = 3)
```

# Пост хок тест для взаимодействия факторов

## Пост хок тесты в многофакторном дисперсионном анализе

- Поскольку взаимодействие достоверно, факторы отдельно можно не тестировать. Проведем пост хок тест по взаимодействию, чтобы выяснить, какие именно группы различаются

- Если бы взаимодействие было недостоверно, мы бы провели пост хок тест по тем факторам, влияние которых было бы достоверно. Как? См. предыдущую презентацию.

## Пост хок тест для взаимодействия факторов

Пост хок тест для взаимодействия факторов делается легче всего "обходным путем" 

1. Создаем переменную-взаимодействие 
2. Подбираем модель без свободного члена 
3. Делаем пост хок тест для этой модели

## Задание 1

Дополните этот код, чтобы посчитать пост хок тест Тьюки по взаимодействию факторов


```{r eval=FALSE, purl=TRUE}
# Создаем переменную-взаимодействие
fert$treat_time <- interaction(fert$treat, fert$time)
# Подбираем линейную модель от этой переменной без свободного члена
fit_inter <- lm()
# Делаем пост хок тест для этой модели
library(multcomp)
dat_tukey <- glht(, linfct = mcp( = "Tukey"))
summary()
```

## Решение

```{r phoc, eval=FALSE, purl=FALSE}
# Создаем переменную-взаимодействие
fert$treat_time <- interaction(fert$treat, fert$time)
# Подбираем линейную модель без свободного члена
fit_inter <- lm(log_rich ~ treat_time - 1, data = fert)
# Делаем пост хок тест для этой модели
library(multcomp)
dat_tukey <- glht(fit_inter, linfct = mcp(treat_time = "Tukey"))
summary(dat_tukey)
```

## Результаты пост хок теста

В виде таблицы результаты нечитабельны Лучше построить график.

\tiny

```{r phoc, echo=FALSE, purl=FALSE}
```

## Данные для графика при помощи `predict()`

У нас два дискретных фактора, поэтому вначале используем `expand.grid()`

```{r}
MyData <- expand.grid(treat = levels(fert$treat),
                      time = levels(fert$time))
MyData <- data.frame(
  MyData,
  predict(fmod2, newdata = MyData, interval = "confidence")
  )
# Обратная трансформация (не забываем про единичку, которую прибавляли)
MyData$richness <- 10^MyData$fit - 1
MyData$LWR <- 10^MyData$lwr - 1
MyData$UPR <- 10^MyData$upr - 1
MyData
```

## Задание 2

Создайте MyData вручную для модели в обычной параметризации:

- предсказанные значения 
- стандартные ошибки
- верхнюю и нижнюю границы доверительных интервалов

```{r eval=FALSE}
MyData <- expand.grid(treat = levels(fert$treat),
                     time = levels())
X <- model.matrix(~ , data = )
betas <- coef()
MyData$fit <- 
MyData$se <-   (X %*% vcov(fmod2) %*% t(X))
MyData$lwr <- MyData$ - 1.96 * 
MyData$upr <- MyData$ + 1.96 * 

# Обратная трансформация
MyData$richness <- 
MyData$LWR <- 
MyData$UPR <- 
MyData
```


```{r task-mydata, purl=FALSE, echo=FALSE}
MyData <- expand.grid(treat = levels(fert$treat),
                     time = levels(fert$time))
X <- model.matrix(~ treat * time, data = MyData)
betas <- coef(fmod2)
MyData$fit <- X %*% betas
MyData$se <- sqrt(diag(X %*% vcov(fmod2) %*% t(X)))
MyData$lwr <- MyData$fit - 1.96 * MyData$se
MyData$upr <- MyData$fit + 1.96 * MyData$se
# Обратная трансформация
MyData$richness <- 10^MyData$fit - 1
MyData$LWR <- 10^MyData$lwr - 1
MyData$UPR <- 10^MyData$upr - 1
MyData
```

## Решение:

```{r task-mydata, purl=FALSE, echo=TRUE}
```

## Задание 3

Постройте график результатов, на котором будут изображены предсказанные средние значения видового богатства в зависимости от тритмента и времени экспозиции.


```{r tidy.opts=list(width.cutoff=60), eval=FALSE, purl=TRUE}
pos <- position_dodge(width = 0.2)
gg_linep <- ggplot(data = , aes()) + 
  geom_  (position = pos) +
  geom_  (aes(group = ), position = pos) +
  geom_  (position = pos, width = 0.1) 
gg_linep
```

```{r gg-lineplot, tidy.opts=list(width.cutoff=60), eval=TRUE, purl=FALSE, echo=FALSE}
pos <- position_dodge(width = 0.2)
gg_linep <- ggplot(data = MyData, aes(x = time, y = richness, 
              ymin = LWR,  ymax = UPR, colour = treat)) + 
  geom_point(position = pos) +
  geom_line(aes(group = treat), position = pos) +
  geom_errorbar(position = pos, width = 0.1) 
gg_linep
```

## График результатов: Линии с точками

```{r gg-lineplot, tidy.opts=list(width.cutoff=60), eval=TRUE, purl=FALSE, echo=TRUE}
```

## Приводим график в приличный вид

```{r tidy.opts=list(width.cutoff=60)}
gg_final <- gg_linep + labs(x = "Экспозиция",  y = "Число видов") + 
  scale_colour_brewer(name = "", palette = "Dark2", 
    labels = c("Контроль", "Эксперимент"))
gg_final
```


## Take home messages

- Многофакторный дисперсионный анализ позволяет оценить взаимодействие факторов. Если оно значимо, то лучше воздержаться от интерпретации их индивидуальных эффектов
- Если численности групп равны, получаются одинаковые результаты вне зависимости от порядка тестирования значимости факторов
- В случае, если численности групп неравны (несбалансированные данные), есть несколько способов тестирования значимости факторов (I, II, III типы сумм квадратов)


## Дополнительные ресурсы

- Quinn, Keough, 2002, pp. 221-250
- Logan, 2010, pp. 313-359
- Sokal, Rohlf, 1995, pp. 321-362
- Zar, 2010, pp. 246-266
