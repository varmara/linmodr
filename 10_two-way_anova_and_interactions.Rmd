---
title: "Дисперсионный анализ, часть 2"
subtitle: "Линейные модели..."
author: "Марина Варфоломеева, Вадим Хайтов"
output:
  beamer_presentation:
    colortheme: beaver
    highlight: tango
    includes:
      in_header: ./includes/header.tex
    pandoc_args:
    - --latex-engine=xelatex
    - -V fontsize=10pt
    - -V lang=russian
    slide_level: 2
    theme: default
    toc: no
institute: "Кафедра Зоологии беспозвоночных, Биологический факультет, СПбГУ"
---

```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
# to render
# rmarkdown::render("10_two-way_anova_and_interactions.Rmd", output_format = "beamer_presentation")
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.show='hold', size='footnotesize', comment="#", warning=FALSE, message=FALSE, dev='cairo_pdf', fig.height=2.5, fig.width=7.7)
# library("extrafont")
```


## Многофакторный дисперсионный анализ

- Модель многофакторного дисперсионного анализа
- Взаимодействие факторов
- Несбалансированные данные, типы сумм квадратов
- Многофакторный дисперсионный анализ в R
- Дисперсионный анализ в матричном виде

### Вы сможете

- Проводить многофакторный дисперсионный анализ и интерпретировать его результаты с учетом взаимодействия факторов

# Данные

## Пример: Удобрение и беспозвоночные

Влияет ли добавление азотных и фосфорных удобрений на беспозвоночных?

Небольшие искуственные субстраты экспонировали в течение разного времени в верхней части сублиторали (Hall et al., 2000).

Зависимая переменная:

- `richness` --- Число видов

Факторы:

- `time` --- срок экспозиции (2, 4 и 6 месяцев)
- `treat` --- удобрения (добавляли или нет)

Планировали сделать 5 повторностей для каждого сочетания факторов

\vskip0pt plus 1filll
\tiny Данные из Quinn, Keough, 2002

## Знакомимся с данными

```{r}
fert <- read.csv(file="data/hall.csv")
str(fert)
# Для удобства названия переменных маленькими буквами
colnames(fert) <- tolower(colnames(fert))
# Время делаем фактором
fert$time <- factor(fert$time)
levels(fert$time)
```

## Пропущенные значения

```{r}
sum(is.na(fert))
sapply(fert, function(x)sum(is.na(x)))
```

> - Нет пропущенных значений

## Объемы выборок в группах

```{r}
table(fert$time, fert$treat)
```

> - Группы разного размера

##   Посмотрим на боксплот

```{r}
library(ggplot2)
theme_set(theme_bw(base_size = 18) + theme(legend.key = element_blank()))
gg_rich <- ggplot(data = fert, aes(x = time, y = richness, colour = treat)) + 
  geom_boxplot()
gg_rich
```

- Вполне возможно, здесь есть гетерогенность дисперсий.

## Преобразовываем данные

На боксплоте видна гетерогенность дисперсий. И 
это неспроста!

Зависимая переменная `richness` -- это счетная величина. Она подчиняется распределению Пуассона (и чем больше ее среднее значение, тем больше дисперсия). 

Правильно было бы воспользоваться обобщенными линейными моделями с Пуассоновским распределением ошибок вместо нормального. Но пока что мы попробуем преобразовать зависимую переменную, чтобы ее распределение стало больше походить на нормальное. Это может помочь, а может и нет.

```{r}
fert$log_rich <- log10(fert$richness + 1)
```

# Модель многофакторного дисперсионного анализа

## Линейные модели с разным числом дискретных предикторов

- Два фактора A и B, двухфакторное взаимодействие

$y _{ijk} = \mu + \alpha _i + \beta _j + (\alpha \beta) _{ij} + \epsilon _{ijk}$

<br /><br />

- Три фактора A, B и C, двухфакторные взаимодействия, трехфакторное взаимодействия

$y _{ijkl} = \mu + \alpha _i + \beta _j + \gamma _k + (\alpha \beta) _{ij} + (\alpha \gamma) _{ik} + (\beta \gamma) _{jk} + (\alpha \beta \gamma) _{ijk} + \epsilon _{ijkl}$


\pause

$\alpha$, $\beta$ и $\gamma$ --- это группы коэффициентов, кодирующие соответствующие факторы.

## Что такое взаимодействие дискретных предикторов

Взаимодействие факторов - когда эффект фактора B разный в зависимости от уровней фактора A и наоборот

\columnsbegin
\column{0.5\textwidth}

\includegraphics{images/interaction.png}

\column{0.5\textwidth}

На каких рисунках есть взаимодействие факторов?

\pause

- b, c - нет взаимодействия (эффект фактора B одинаковый для групп по фактору A, линии для разных групп по фактору B на графиках расположены параллельно)
- a, d - есть взаимодействие (эффект фактора B разный для групп по фактору A, на графиках линии для разных групп по фактору B расположены под наклоном).

\columnsend

\vskip0pt plus 1filll
\tiny Рисунок из Logan, 2010, fig.12.2


## Влияют ли главные эффекты и взаимодействие?

\includegraphics{images/interaction1a.png}


\pause

- взаимодействие недостоверно
  - фактор А влияет
  - фактор В влияет

\vskip0pt plus 1filll
\tiny Рисунок из Quinn, Keough, 2002, fig.9.3



## Влияют ли главные эффекты и взаимодействие?

\includegraphics{images/interaction1b.png}

\pause

- взаимодействие достоверно и мешает интерпретировать влияние факторов отдельно:
    - для В2 зависимая переменная возрастает с изменением уровня А
    - для В1 зависимая переменная возрастает только на А2, но не различается на А1 и А3
- если смотреть на главные эффекты, можно сделать неправильные выводы:
    - фактор А влияет, группы А2 и А3 не отличаются
    - фактор В влияет, в группе В2 зависимая переменная больше, чем в В1

\vskip0pt plus 1filll
\tiny Рисунок из Quinn, Keough, 2002, fig.9.3



## Влияют ли главные эффекты и взаимодействие?

\includegraphics{images/interaction1c.png}

\pause

- взаимодействие достоверно и мешает интерпретировать влияние факторов отдельно:
    - А1В2, А3В2 и А2В1 не различаются, значение зависимой переменной в этих группах выше, чем в остальных
    - А1В1, А3В1 и А2В2 не различаются
- если смотреть на главные эффекты, можно сделать неправильные выводы:
    - факторы А и В не влияют

\vskip0pt plus 1filll
\tiny Рисунок из Quinn, Keough, 2002, fig.9.3



## Взаимодействие факторов может маскировать главные эффекты

### Если есть значимое взаимодействие
- главные эффекты обсуждать не имеет смысла  
- пост хок тесты проводятся только для ваимодействия


\includegraphics{images/interaction1.png}

\vskip0pt plus 1filll
\tiny Рисунок из Quinn, Keough, 2002, fig.9.3


# Двухфакторный дисперсионный анализ в матричном виде

## Двухфакторный дисперсионный анализ в матричном виде (contr.treatment)

Уравнение линейной модели для этого примера (в параметризации фиктивных переменных, contr.treatment):

$$y _{i} = \beta _0 + \beta _1 x _{1i} + \cdots + \beta _5 x _{5i} + \varepsilon _{i}$$

- Здесь $i = 1, ..., n$, т.е. порядковый номер наблюдения,
- $x _{1i}, ..., x _{5i}$ --- переменные-болванки
- $\beta_0$ - видовое богатство в контроле (при экспозиции 2)
- $\beta_1$ - изменение видового богатства при добавлении удобрений (при экспозиции 2)
- $\beta_2$ и $\beta_3$ - изменение видового богатства в контроле при экспозиции 4 и 6 соответственно
- $\beta_4$ и $\beta_5$ - изменение видового богатства при добавлении удобрений при экспозиции 4 и 6 соответственно

Остальное все так же как в предыдущем примере с однофакторным анализом.

$$\mathbf{Y} = \mathbf{X} \mathbf{\beta} + \mathbf{\varepsilon}$$

## Для параметризации эффектов (contr.sum) дискретные предикторы кодируются иначе

\small

В модели эффектов (contr.sum) переменные-болванки будут закодированы при помощи -1, 0 и 1, так, чтобы сумма кодов для возможных состояний одной переменной была равна нулю.

Уровни фактора "удобрения" закодированы с помощью одной переменной:

```{r}
contr.sum(levels(fert$treat))
```

Уровни фактора "время экспозиции" --- с помощью двух переменных:

```{r}
contr.sum(levels(fert$time))
```

Модельная матрица целиком

```{r}
X_sum <- model.matrix(~ treat*time, fert, 
  contrasts = list(treat = "contr.sum", time = "contr.sum"))
X_sum
```


## Двухфакторный дисперсионный анализ в матричном виде (contr.sum)

Уравнение линейной модели для этого примера (в параметризации фиктивных переменных, contr.sum):

$$y _{i} = \beta _0 + \beta _1 x _{1i} + \cdots + \beta _5 x _{5i} + \varepsilon _{i}$$

- Здесь $i = 1, ..., n$, т.е. порядковый номер наблюдения,
- $x _{1i}, ..., x _{5i}$ --- переменные-болванки

- $\beta_0$ - средний уровень видового богатства во всех пробах
- $\beta_1$ - фактор "тритмент", отклонение тритментов от общего среднего (в модельной матрице опыт закодирован как +1, удобрения -1, (сумма кодов 0))
- $\beta_2 + \beta_3$ - фактор "время", отклонение видового богатства при разной экспозиции от общего среднего
- $\beta_4 + \beta_5$ - взаимодействие, отклонение видового богатства в тритментах при разных экспозициях от общего среднего



# Несбалансированные данные, типы сумм квадратов

## Несбалансированные данные - когда численности в группах по факторам различаются

\columnsbegin

\column{0.5\textwidth}

Например так,

|    | A1 | A2 | A3 |
|----|----|----|----|
| B1 |  5 | 5  |  5 |
| B2 |  5 | 4  |  5 |


\column{0.5\textwidth}

или так,


|    | A1 | A2 | A3 |
|----|----|----|----|
| B1 |  3 | 8  |  4 |
| B2 |  4 | 7  |  4 |

\columnsend

## Проблемы несбалансированных дизайнов

- Оценки средних в разных группах с разным уровнем точности (Underwood 1997)
- ANOVA менее устойчив к отклонениям от условий применимости (особенно от гомогенности дисперсий) при разных размерах групп (Quinn Keough 2002, section 8.3)
- Проблемы с рассчетом мощности. Если $\sigma _{\epsilon}^2 > 0$ и размеры выборок разные, то $MS _{factor} \over MS _{residuals}$ не следует F-распределению (Searle et al. 1992).

\vfill
\pause

- Cтарайтесь _планировать_ группы равной численности!
- Но если не получилось - не страшно:
    - Для фикс. эффектов неравные размеры - проблема только если значения доверительной вероятности _p_ близки к выбранному критическому уровню значимости $\alpha$

## Если несбалансированные данные, выберите правильный тип сумм квадратов

- SSe и SSab также как в сбалансированных
- SSa, SSb - три способа расчета

- Для сбалансированных дизайнов - результаты одинаковы
- Для несбалансированных дизайнов рекомендуют __суммы квадратов III типа__ если есть взаимодействие факторов (Maxwell & Delaney 1990, Milliken, Johnson 1984, Searle 1993, Yandell 1997)

## Порядок тестирования гипотез в дисперсионном анализе

\resizebox{1\textwidth}{!}{
\begin{tabular}{L{0.25\textwidth} C{0.25\textwidth} C{0.25\textwidth} C{0.25\textwidth}}
\hline\noalign{\smallskip}
"Типы сумм квадратов" & I тип & II тип & III тип \\
\hline\noalign{\smallskip}
Название & Последовательная & Без учета взаимодействий высоких порядков & Иерархическая \\
SS & 
SS(A) \linebreak SS(B | A)  \linebreak SS(AB | B, A) & 
SS(A | B) \linebreak SS(B | A) \linebreak SS(AB | B, A) & 
SS(A | B, AB) \linebreak SS(B | A, AB) \linebreak SS(AB | B, A) \\
Величина эффекта зависит от выборки в группе & Да & Да & Нет \\
Результат зависит от порядка включения факторов в модель & Да & Нет & Нет \\
Команда R & aov() & Anova() (пакет car) &  Anova() (пакет car) \\
\hline\noalign{\smallskip}
\end{tabular}
}

# Многофакторный дисперсионный анализ в R

## Дисперсионный анализ со II типом сумм квадратов

Сначала тестируем взаимодействие, затем тестируем факторы в модели без взаимодействия

```{r}
fmod2 <- lm(log_rich ~ treat * time, data = fert)
library(car)
Anova(fmod2, type = "II")
```


## Задание

Проверьте условия применимости дисперсионного анализа

## Решение

```{r purl=FALSE}
library(car)
op <- par(mfrow = c(1, 3))
plot(fmod2, which = 4)
plot(fmod2, which = 1)
qqPlot(fmod2)
par(op)
```

- Выбросов нет
- Дисперсии почти одинаковые. Может быть, в одной из групп больше
- Остатки нормально распределены

## Графики остатков от переменных в модели


```{r fig.height=4}
residualPlots(fmod2)
```

- По-видимому, с увеличением продолжительности экспозиции дисперсия остатков уменьшается.


## Результаты дисперсионного анализа

```{r, R.options=list(width = 45)}
Anova(fmod2, type = 2)
```

## Дисперсионный анализ c III типом сумм квадратов

На случай, если вдруг вам понадобится воспроизвести в R дисперсионный анализ с III типом сумм квадратов.

Тестируем взаимодействие, когда все другие факторы есть в модели. Затем тестируем факторы, когда все другие факторы и взаимодействие есть в модели.

Внимание: при использовании III типа сумм квадратов, нужно __обязательно указывать тип контрастов для факторов__ (`contrasts=list(фактор_1 = contr.sum, фактор_2=contr.sum)`).

```{r tidy.opts=list(width.cutoff=40)}
fmod3 <- lm(log_rich ~ treat * time, data = fert, contrasts = list(treat = contr.sum, time = contr.sum))
Anova(fmod3, type = 3)
```


# Пост хок тест для взаимодействия факторов

## Пост хок тесты в многофакторном дисперсионном анализе

- Поскольку взаимодействие достоверно, факторы отдельно можно не тестировать. Проведем пост хок тест по взаимодействию, чтобы выяснить, какие именно группы различаются

- Если бы взаимодействие было недостоверно, мы бы провели пост хок тест по тем факторам, влияние которых было бы достоверно. Как? См. предыдущую презентацию.

## Пост хок тест для взаимодействия факторов

Пост хок тест для взаимодействия факторов делается легче всего "обходным путем" 

1. Создаем переменную-взаимодействие 
2. Подбираем модель без свободного члена 
3. Делаем пост хок тест для этой модели

```{r phoc, eval=FALSE}
fert$treat_time <- interaction(fert$treat, fert$time)
fit_inter <- lm(log_rich ~ treat_time - 1, data = fert)
library(multcomp)
dat_tukey <- glht(fit_inter, linfct = mcp(treat_time = "Tukey"))
summary(dat_tukey)
```

## Результаты пост хок теста

\small

```{r phoc, echo=FALSE}
```

## Данные для графика при помощи `predict()`

```{r}
MyData <- expand.grid(treat = levels(fert$treat),
                      time = levels(fert$time))
MyData <- data.frame(MyData,
  predict(fmod2, newdata = MyData,
          interval = "confidence"))
# Обратная трансформация
MyData$richness <- 10^MyData$fit
MyData$LWR <- 10^MyData$lwr
MyData$UPR <- 10^MyData$upr
MyData
```

## Задание:

Создайте MyData вручную:

- предсказанные значения 
- стандартные ошибки
- верхнюю и нижнюю границы доверительных интервалов

## Решение:

```{r purl=FALSE}
MyData <- expand.grid(treat = levels(fert$treat),
                     time = levels(fert$time))
X <- model.matrix(~ treat * time, data = MyData)
betas <- coef(fmod2)
MyData$fit <- X %*% betas
MyData$se <- sqrt(diag(X %*% vcov(fmod2) %*% t(X)))
MyData$lwr <- MyData$fit - qnorm(0.975) * MyData$se
MyData$upr <- MyData$fit + qnorm(0.975) * MyData$se
# Обратная трансформация
MyData$richness <- 10^MyData$fit
MyData$LWR <- 10^MyData$lwr
MyData$UPR <- 10^MyData$upr
MyData
```

## Графики для результатов: Столбчатый график

```{r tidy.opts=list(width.cutoff=60)}
pos <- position_dodge(width = 0.9)
gg_barp <- ggplot(data = MyData, aes(x = time, y = richness, 
            ymin = LWR,  ymax = UPR, fill = treat)) +  
  geom_bar(stat = "identity", position = pos) +  
  geom_errorbar(width = 0.1, position = pos)
gg_barp
```


## Графики для результатов: Линии с точками

```{r tidy.opts=list(width.cutoff=60)}
gg_linep <- ggplot(data = MyData, aes(x = time, y = richness, 
              ymin = LWR,  ymax = UPR, colour = treat)) + 
  geom_point(size = 3, position = pos) +
  geom_line(aes(group = treat), position = pos) +
  geom_errorbar(width = 0.1, position = pos) 
gg_linep
```

## Приводим понравившийся график в приличный вид

```{r tidy.opts=list(width.cutoff=60)}
gg_final <- gg_linep + labs(x = "Экспозиция",  y = "Число видов") + 
  scale_colour_brewer(name = "", palette = "Dark2", 
    labels = c("Контроль", "Эксперимент"))
gg_final
```


## Take home messages

- Многофакторный дисперсионный анализ позволяет оценить взаимодействие факторов. Если оно значимо, то лучше воздержаться от интерпретации их индивидуальных эффектов
- Если численности групп равны - получаются одинаковые результаты с использованием I, II, III типы сумм квадратов
- В случае, если численности групп неравны (несбалансированные данные) по разному тестируется значимость факторов (I, II, III типы сумм квадратов)



## Дополнительные ресурсы

- Quinn, Keough, 2002, pp. 221-250
- Logan, 2010, pp. 313-359
- Sokal, Rohlf, 1995, pp. 321-362
- Zar, 2010, pp. 246-266
