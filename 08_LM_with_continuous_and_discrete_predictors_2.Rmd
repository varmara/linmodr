---
title: "Дискретные предикторы в линейных моделях"
author: Вадим Хайтов, Марина Варфоломеева
output:
  ioslides_presentation:
    widescreen: true
    css: assets/my_styles.css
    logo: assets/Linmod_logo.png
  beamer_presentation:
    colortheme: beaver
    highlight: tango
    includes:
      in_header: ./includes/header.tex
    pandoc_args:
    - --latex-engine=xelatex
    - -V fontsize=10pt
    - -V lang=russian
    slide_level: 2
    theme: default
    toc: no
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.align='center', tidy = FALSE, fig.width = 7, fig.height = 3, warning = FALSE)
```

## Мы рассмотрим

+ Линейные модели c непрерывными и дискретными предикторами

# Дискретные предикторы, или факторы

## Простую линейную модель можно усложнить
 
Мы уже умеем описывать реальность с помощью моделей.   
Например, модель движения автомобиля выглядит так: 

$$S=Vt$$
Можем ли мы построить модель движения машины, у которой может быть два разных водителя, предпочитающих ездить с разными скоростями?

## На сцене появляются факторы 

Путь, проделанный машиной за некоторое время $t$, будет зависеть от того, кто сидел за рулем.

Это будет множественная модель, включающая помимо непрерывного предиктора $t$ еще и  дискретный предиктор "Водитель", `Driver`.

Дискретные предикторы по традиции называют "факторами".

У фактора `Driver` есть две градации (levels): `Driver_1` и `Driver_2` 

<!-- Модель будет предсказывать разную величину пройденного пути, в зависимости от того, кто сидел за рулем (`Водитель_1` или  `Водитель_2`). -->

<!-- График модели будет разным для двух градаций дскретного фактора. -->


## График модели с дискретным фактором

```{r echo=FALSE, purl=FALSE}
library(ggplot2)
t <- rep(0:9, 2)
S <- data.frame(time = t)
S$time <- S$time 
S$S = S$time * rep(c(60, 80), each = 10)
S$car = rep(c('car1', 'car2'), each = 10)

Plot_speed <- ggplot(S, aes(x = t, y = S)) + 
  geom_line(aes(colour = car), size = 1) +
  labs(x ='Время', y = 'Путь', colour = 'Фактор \nDriver') +  
  theme_bw()
Plot_speed
```


График модели будет разным для двух градаций дискретного фактора.

От значения фактора `Driver` зависит угловой коэффициент модели.

## Формула для усложненной модели 

Модель можно представить в виде формулы, но старая формула $S=Vt$ не годится!


Новая формула:

$$S = (V_1 + b_2 \cdot I_{Driver_2})t$$ 

- $V_1$ -- Скорость водителя №1   
- $t$ -- Время
-  $I_{Driver_2}$ -- Переменная-индикатор
- $b_2$ -- Поправочный коэффициент, показывающий на сколько скорость второго водителя отличается от скорости первого.


## Запись модели в привычных обозначениях линейных моделей

Ту же самую модель можно записать в привычных обозначениях, использованных ранее:

$$y = b_1 x + b_2 \cdot I_{Driver_2} \cdot x$$ 

- $y$ --- зависимая величина (путь)  
- $x$ --- предиктор (время)
- $b_1$ --- коэффициент, равный скорости `Водителя_1` 
- $b_2$ --- коэффициент, показывающий насколько скорость второго водителя отличается от скорости первого
- $I_{Driver_2}$ --- переменная-индикатор

## Переменная-индикатор (Dummy variable)

$$y = b_1 x + b_2 \cdot I_{Driver_2}\cdot x$$ 

$I_{Driver_2}$ --- переменная-индикатор:

- $I_{Driver_2} = 0$ если рассматриваем водителя №1
- $I_{Driver_2} = 1$ если рассматриваем водителя №2   

**Переменные-индикаторы**, или переменные-болванки (dummy variable), "переключают" модель между разными уровнями дискретного фактора.

## Базовый уровень дискретного фактора

У дискретных факторов всегда есть **базовый уровень**.

Базовый уровень --- это градация дискретного предиктора, относительно которой вычисляются коэффициенты модели.  

В нашей модели в качестве базового уровня фактора `Driver` выбрана градация `Driver_1`.



## Поправочный коэффициент 

$$y = b_1 x + b_2 \cdot I_{Driver_2}\cdot x$$ 

$b_2$ --- поправочный коэффициент, который показывает, **на сколько единиц** (км/ч) отличается скорость `Driver_2` от скорости на базовом уровне (`Driver_1`).


## Формулы для разных уровней

Пусть скорость, которую развивает второй водитель, будет на 20 км/ч выше ($b_2 = 20$), чем скорость первого водителя ($b_1$).


Модель для `Driver_1` (базовый уровень):
\vspace{-1\baselineskip}

$$
I_{Driver_2}=0 \qquad\qquad
y = b_1 x + 20 \cdot 0 \cdot x = b_1   x \qquad\quad
$$

Модель для `Driver_2` 
\vspace{-1\baselineskip}

$$
I_{Driver_2} = 1 \qquad\qquad
y = b_1 x + 20 \cdot 1\cdot x = (b_1 + 20)x 
$$



## Если уровней становится больше 

Предположим, вы бронируете номер в гостинице, где могут быть номера \linebreak с двумя кроватями (Twin room), \linebreak с одной большой кроватью (Double room) \linebreak и семейные номера (Family room).  

Модель затрат на оплату проживания в зависимости от  времени должна включать дискретный предиктор `Room_type` с тремя градациями: `Twin`, `Double`, `Family`.

## Модель, включающая фактор с несколькими градациями

```{r, echo = FALSE, purl=FALSE}
t <- rep(1:10, 3)
cost <- data.frame(time = t)
cost$Cost [1:10] <- cost$t [1:10] * 10 + 0
cost$Cost [11:20] <- cost$t [11:20] * 10 + 5
cost$Cost [21:30] <- cost$t [21:30] * 10 + 20
cost$Room_type <- rep(c('Twin', 'Double', 'Family'), each = 10)

Pl_room <- ggplot(cost, aes(x = t, y = Cost)) +
  geom_line(aes(colour = Room_type), size = 1) +
  labs(x ='Время проживания', y = 'Потраченная сумма', colour = 'Фактор \nRoom_type') +   theme_bw()
Pl_room
```

Все три графика параллельны, \linebreak но одни выше, другие -- ниже. 

## Уравнениие для трех прямых

$y = b_1  x + b_2 \cdot I_{Double} + b_3 \cdot I_{Family}$

- $y$ --- зависимая переменная (потраченная сумма)  
- $x$ --- непрерывный предиктор (время)   
- $b_1$ --- цена одной ночи в номере `Twin` (базовый уровень)    
- $b_2$ --- на сколько единиц цена номера `Double` отличается от базового уровня   
- $b_3$ --- на сколько единиц цена номера `Family` отличается от базового уровня   
- $I_{Double}, I_{Family}$ --- переменные-индикаторы   

## Переменные-индикаторы в уравнениях

Общее уравнение:

$$\qquad y = b_1  x_i + b_2 \cdot I_{Double} + b_3 \cdot I_{Family}$$


- Уравнение для проживания в номере типа `Twin` (базовый уровень):

$$y = b_1 x + b_2 \cdot 0 + b_3 \cdot 0 = b_1 \cdot x$$

- Уравнение для проживания в номере типа `Double`:

$$y = b_1 x + b_2 \cdot 1 + b_3 \cdot 0 = b_1 x + b_2$$

- Уравнение для проживания в номере типа `Family`:

$$y = b_1 x + b_2 \cdot 0 + b_3 \cdot 1 = b_1 x + b_3$$ 



## Отсутствие взаимодействия предикторов

```{r echo=FALSE, purl=FALSE}
Pl_room
```

Если характер связи зависимой переменной с непрерывным предиктором одинаков для разных градаций дискретного фактора (прямые параллельны), то говорят, что  **между предикторами отсутствует взаимодействие**.

# Взаимодействие предикторов  


## Взаимодействие предикторов вокруг нас


Изменение размера счета в банке зависит от уровня доходов человека, от уровня его трат и т.п. 

Сумма на банковском счете у людей, занимающих разные должности, разная.

Поэтому модель, описывающая изменение суммы на счете, должна включать дискретный фактор `Position` (Должность).


## Кто-то богатеет, а кто-то не очень

```{r, echo=FALSE, purl=FALSE}

acount <- data.frame(t = rep(1:12, 2))
acount$Amount [1:12] <- acount$t [1:12] * -1 + 0
acount$Amount [13:24] <- acount$t [13:24] * 10 + 20
acount$Position <- rep(c('Position_1', 'Position_2'), each = 12)

ggplot(acount, aes(x = t, y = Amount)) + 
  geom_line(aes(colour = Position), size = 1) +  theme_bw()

```


Графики не параллельны -- у них различаются как значения свободного члена (intercept), так и угловые коэффициенты (slope). 

В такой ситуации говорят, что между дискретным фактором (`Position`, должность) и непрерывным предиктором (`X`, время) существует **взаимодействие**.


## Уравнение модели

$$
y = b_0 + b_1x + b_2 \cdot I_{Position_2}  + b_3 \cdot  I_{Position_2}  \cdot x
$$

- $y$ --- зависимая переменная (сумма на банковском счете)
- $x$ --- предиктор (время)
- $b_0$ --- состояние счета работника на должности №1 в начальный момент времени ($X=0$)
- $b_1$ --- коэффициент, равный доходам (руб/мес) сотрудника на должности №1
- $I_{Position_2}$ --- переменная-индикатор
- $b_2$ --- коэффициент, показывающий,  на сколько рублей банковский счет на должности №2 отличается от счета сотрудника на должности №1 в начальный момент времени ($x = 0$)
- $b_3$ --- на сколько единиц (руб/мес) доходы сотрудника на должности №2 отличаются от доходов сотрудника на должности №1



## Переменные-индикаторы в уравнениях

Общее уравнение: 

$$y = b_0 + b_1x + b_2 \cdot I_{Position_2}  + b_3 \cdot  I_{Position_2}  \cdot x$$

- Уравнение для должности №1 (базовый уровень):

$$\begin{aligned}y &= b_0 + b_1x + b_2 \cdot 0  + b_3 \cdot  0  \cdot x = \\
&= b_0 + b_1x\end{aligned}$$ 

- Уравнение для должности №2: 

$$\begin{aligned}
y &= b_0 + b_1x + b_2 \cdot 1  + b_3 \cdot  1  \cdot x = \\ 
&= b_0 + b_1x + b_2   + b_3 \cdot x = \\ 
&=  (b_0 + b_2) + (b_1 + b_3)x
\end{aligned}$$

У нас еще будет детальный разговор о взаимодействии дискретных и непрерывных предикторов. 


## А как в регрессионных моделях?

Мы рассмотрели простейшие **детерминистские** модели. 

В регрессионном анализе все аналогично!

Но есть две особенности:  

- В моделях добавляется случайная часть. Они становятся стохастическими.     
-  Мы заранее не можем сказать, есть ли в изучаемой системе взаимодействие предикторов или его нет. Выявление взаимодействия между предикторами --- специальная задача.    



# Пример --- козы, глисты и линейные модели  



## Глистогонные средства и рост коз

Как связан прирост массы коз с начальным весом животного и интенсивностью профилактики паразитарных заболеваний?

<div class="columns-2">

<img src="images/Goat-by-Jennifer-C.-Flickr.jpg" width="300" height="300">
<small> Goat by Jennifer C. [on Flickr](https://flic.kr/p/fjU4J9) </small>


- `Treatment` - обработка от глистов (стандартная, интенсивная)
- `Weightgain` - привес, кг
- `Initial.wt` - начальный вес, кг



<small>
<div class=.footnote>Пример из библиотеки данных
http://www.statlab.uni-heidelberg.de/data/ancova/goats.story.html</div>

</small>
  
</div>

## Читаем данные и знакомимся с ними

```{r}
library(readxl)
goat <- read_excel("data/goats.xlsx", sheet = 1)
head(goat)
str(goat)
```

## Читаем данные и знакомимся с ними

```{r}
colSums(is.na(goat))
# переименуем переменные для краткости
colnames(goat) <- c("Treatment", "Wt", "Stw")
# объемы выборок
table(goat$Treatment)
goat$Treatment <- factor(goat$Treatment)
```

## Есть ли выбросы?

```{r dot-plots, fig.height=2}
library(ggplot2)
gg_dot <- ggplot(goat, aes(y = 1:nrow(goat))) + geom_point()
gg_dot + aes(x = Wt)
gg_dot + aes(x = Stw)
```

## Строим модель
Нас интересует, как зависит прирост массы коз (`Wt`) от непрерывного предиктора (`Stw`) и дискретного фактора  `Treatment`. 

Но! Мы не можем сразу решить есть ли в системе взаимодействие или его нет. Поэтому мы должны рассмотреть модель, в которой взаимодействие будет включено.  


Зависимость в генеральной совокупности:

$$
Wt_i = \beta_0 + \beta_1Stw_i + \beta_2 \cdot I_{standart\,i} + \beta_3 \cdot I_{standart\,i} \cdot Stw_i + \varepsilon_i, \quad \varepsilon \sim N(0, \sigma)
$$

Модель, подобранная по выборке:

$$
Wt_i = b_0 + b_1Stw_i + b_2 \cdot I_{standart\,i} + b_3 \cdot I_{standart\,i} \cdot Stw_i + e_i
$$

Предсказанные значения:

$$
\widehat{Wt}_i = b_0 + b_1Stw_i + b_2 \cdot I_{standart\,i} + b_3 \cdot I_{standart\,i} \cdot Stw_i
$$



## Строим полную модель

Мы не знаем, взаимодействуют ли дискретный фактор `Treatment` и непрерывный предиктор `Stw`.   

Возможна ситуация, при которой худые и жирные козы будут по-разному реагировать на разные типы антигельминтной терапии.

В полной модели мы должны учесть как влияние самих предикторов, так и влияние их взаимодействия.

```{r}
Mod_goat_full <- lm(Wt ~ Stw + Treatment + Stw:Treatment, data = goat)

# Аналогичная, но более короткая запись
Mod_goat_full <- lm(Wt ~ Stw * Treatment, data = goat)


```

Базовым уровнем фактора будет значение `Treatment` = `intensive`. \linebreak По умолчанию в R используется первое по алфавиту значение.


## Можно ли не учитывать взаимодействие предикторов?

```{r}
drop1(Mod_goat_full, test = 'F')
```

Значимого взаимодействия не наблюдается!

## Строим сокращенную модель
Формула сокращенной модели

$$
Wt_i = b_0 + b_1Stw_i + b_2 \cdot I_{standart\,i} + e_i
$$

\vspace{-1\baselineskip}

$$
\widehat{Wt}_i = b_0 + b_1Stw_i + b_2 \cdot I_{standart\,i} 
$$

Можно просто переписать формулу.

```{r}

# Можно просто переписать формулу
Mod_goat_reduced <- lm(Wt ~ Stw + Treatment, data = goat)
```

Но есть более удобный способ.

```{r}
Mod_goat_reduced <- update(Mod_goat_full, . ~ . - Stw:Treatment)
```

Пока не смотрим в `summary()`!




# Диагностика модели  

## Нет ли коллинеарности между начальным весом и типом обработки?


```{r}
library(car)
vif(Mod_goat_reduced)
```

## Нет ли коллинеарности между начальным весом и типом обработки?

```{r}
ggplot(goat, aes(x = Treatment, y = Stw)) + 
  geom_boxplot()
```

Выраженной коллинеарности нет.




## Строим диагностические графики

```{r}
MG_diag <- fortify(Mod_goat_reduced)
  Pl_diag1 <- ggplot(MG_diag, aes(x = 1:nrow(MG_diag), y = .cooksd)) +
    geom_bar(stat = 'identity')
  
  Pl_diag2 <- ggplot(MG_diag, aes(x = .fitted, y = .stdresid)) +
    geom_point() + geom_hline(yintercept = 0)
  
  Pl_diag3 <- ggplot(MG_diag, aes(x = Stw, y = .stdresid)) +
    geom_point() + geom_hline(yintercept = 0)
  
  Pl_diag4 <- ggplot(MG_diag, aes(x = Treatment, y = .stdresid)) +
    geom_boxplot()
```


## Строим диагностические графики

```{r}
library(cowplot)
plot_grid(Pl_diag1, Pl_diag2, Pl_diag3, Pl_diag4, nrow = 2)

```


Влиятельных наблюдений нет.  
Гетерогенности дисперсий нет.


## Нормальность распределения остатков

```{r purl=TRUE}
qqPlot(Mod_goat_reduced, id = FALSE) # функция из пакета car
```


# Трактовка регрессионной модели, включающей один дискретный и один непрерывный предиктор  
## График модели

```{r gg-predictions_1}
gg_goat <- ggplot(data = goat, aes(y = Wt, x = Stw, colour = Treatment)) +
  geom_point()  +
  labs(x = 'Начальный вес, кг', y = 'Привес, кг') +
  scale_colour_discrete('Способ обработки',
                  breaks = c('intensive', 'standard'),
                  labels = c('Интенсивный', 'Стандартный'))
gg_goat
```

## Добавляем линии регрессии

```{r gg-predictions_2}
library(dplyr)
new_data <- goat %>% group_by(Treatment)%>%
  do(data.frame(Stw = seq(min(.$Stw), max(.$Stw), length.out = 10))) 
new_data$fit = predict(Mod_goat_reduced, newdata = new_data)

gg_goat + geom_line(data = new_data, aes(x = Stw, y = fit, colour = Treatment)) 
```


## Находим границы доверительной области

```{r gg-predictions_3}
# Находим вариационно-ковариационную матрицу для модели Mod_goat_reduced
VC <- vcov(Mod_goat_reduced)

# Модельная матрица
X <- model.matrix(~ Stw + Treatment, data = new_data)

# Стандартные ошибки
new_data$se <- sqrt(diag(X %*% VC %*% t(X)))

# t для расчета 95% доверительного интервала 
t_crit <- qt(0.975, df = nrow(goat) - length(coef(Mod_goat_reduced))) 
# t для расчета доверит. интервала 

# Границы доверительных интервалов
new_data$upr <- new_data$fit + t_crit * new_data$se
new_data$lwr <- new_data$fit - t_crit * new_data$se
```


## Наносим на график границы доверительной области


```{r}
gg_goat + geom_line(data = new_data, aes(x = Stw, y = fit, colour = Treatment)) + 
  geom_ribbon(data = new_data, 
              aes(x = Stw, y = fit, ymin = lwr, ymax = upr, 
                  fill = Treatment), alpha = 0.3, size = 0) + 
  scale_fill_discrete('Способ обработки',
                  breaks = c('intensive', 'standard'),
                  labels = c('Интенсивный', 'Стандартный'))
```



## График модели

```{r gg-predictions, purl=FALSE, echo=FALSE}
gg_g <- ggplot(data = goat, aes(y = Wt, x = Stw, colour = Treatment)) +
  geom_point()  +
  labs(x = "Начальный вес, кг",
       y = "Привес, кг") +
  scale_colour_discrete("Способ обработки",
                        breaks = c("intensive", "standard"),
                        labels = c("Интенсивный", "Стандартный"))
MyData <- unique(goat[ , c("Stw", "Treatment")])
MyData$Predict <- predict(Mod_goat_reduced, newdata = MyData)
gg_g + geom_line(data = MyData, aes(x = Stw, y = Predict, color = Treatment))
```


## О чем говорят числа в `summary()` {.smaller}

```{r}
summary(Mod_goat_reduced)
```

В `summary()` появилась строка `Treatmentstandard`. 

Почему не `Treatment`? 

## Информация в `summary()` необходима для построения уравнения модели {.smaller}

У нас две линии   

Первая: 
$$Wt =  14.97  - 0.3514 Stw$$

Эта прямая описывает связь между  $Wt$ и $Stw$ для той градации фактора `Treatment`, которая взята за **базовый уровень**. По умолчанию в качестве базового уровня берется первая по алфавиту градация дискретного фактора. В данном случае - это градация `intensive`


Вторая линия описывает связь между $Wt$ и $Stw$ для второй градации фактора `Treatment`. уравнение этой прямой будет таким:

$$
Wt = 14.97 -0.3514 Stw -1.2649 \\
Wt = 13.7 -0.3514 Stw
$$

## Смысл коэффициентов при дискретных предикторах {.smaller}

_Смысл 1._  
Коэффициенты при дискретных предикторах показывают **на сколько единиц** смещается `Intercept` у данного (указанного в `summsry()`) уровня по  отношению к базовому уровню

_Смысл 2._   
На сколько единиц отличается среднее значение зависимой переменной для данного (указанного в `summsry()`) уровня от среднего значения зависимой переменной для базового уровня.   

Уровень значимости в `summary()` говорит о статистической значимости этих отличий (при _попарном_ сравнении; если уровней больше двух, то помните про проблемы множественности сравнений) 


## Общее уравнение модели 


Уравнение приобретает такой вид 

$$
Wt = 14.97 - 0.35Stw - 1.26I_{standard}
$$

В этом уравнении появилась переменная $I$ - это переменная-селектор (dummy variable, переменная-болванка)

$I = 0$ если мы рассматриваем базовый уровень дискретного предиктора.  В данном случае уровень `Treatment` = "initial"  

$I = 1$ если мы рассматриваем другой уровень дискретного предиктора. В данном случае уровень `Treatment` = "standard"  


## Меняем базовый уровень

```{r}
goat$Treatment <- relevel(goat$Treatment, ref = "standard")
levels(goat$Treatment)
```

## Строим новую модель

```{r}
Mod_goat_reduced_2 <- lm(Wt ~ Stw + Treatment, data = goat)

```

## Результаты {.smaller}
```{r}
summary(Mod_goat_reduced_2)
```

Что изменилось?

## Уравнения

Общее уравнение модели

$$
Wt = 13.7017 -0.3514 Stw + 1.2649 I_{intensive}
$$
Постройте уравнения для каждого из уровней фактора `Treatment`....


## Как охарактеризовать влияние двух предикторов в целом

```{r}
library(car)
Anova(Mod_goat_reduced, type = 3)
```

## Вывод:  

Привес коз при интенсивной обработке от глистов на 1.26 кг выше, чем при стандартном методе обработки (ANOVA, p =0.018). Привес коз демонстрирует отрицательную связь с начальным весом животного (ANOVA, p < 0.01).



# Общие линейные модели 


## Много сторон одной медали

Мы уже рассмотрели довольно много статистических методов:    

- Простая регрессия;    
- Множественная регрессия;    
- Регрессионный анализ с дискретными и непрерывными предикторамию    

Все они являются реализациями одного и того же метода --- **общие линейные модели**.

**NB!** "Общие линейные модели" (General linear models) нельзя путать с "обобщенными линейными моделями" (Generalized linear models).

## Общий вид линейных моделей  

Все разновидности линейных моделей описываются общей формулой

$$
\textbf{y} = \textbf{X} \textbf{b} + \textbf{e} 
$$

- $\textbf{y}$ --- вектор наблюдаемых значений
- $\textbf{X}$ --- модельная матрица, характеризующая "поведение" предикторов 
- $\textbf{b}$ --- вектор коэффициентов модели
- $\textbf{e}$ --- вектор, описывающая случайные отклонения

 
В случае общих линейных моделей  подбор параметров модели (вектор $\textbf{b}$) производится **методом наименьших квадратов**.



## Общие линейные модели в матричном виде

$$\mathbf{y} = \mathbf{X} \mathbf{b} + \mathbf{e}$$

$$
\begin{pmatrix}
y_1 \\ y_2 \\ \vdots \\ y_n
\end{pmatrix} =
\begin{pmatrix}
1 & x_{11} & \cdots & x_{p-1\ 1} \\
1 & x_{12} & \cdots & x_{p-1\ 2} \\
\vdots & & & \\
1 & x_{1n} & \cdots & x_{p-1\ n}
\end{pmatrix} \times
\begin{pmatrix}
b _0 \\ b _1 \\ b _2 \\  \vdots \\  b_{p-1}
\end{pmatrix} +
\begin{pmatrix}
e _1 \\ e _2 \\ \vdots \\ e _n
\end{pmatrix}
$$

- $\mathbf{y}$ --- вектор значений зависимой переменной, один столбец в _n_ строк (_n_ - число наблюдений)
- $\mathbf{X}$ --- модельная матрица  с _n_ строк. Ее первый столбец содержит единицы, далее по столбцу для каждой из переменных в модели. Количество столбцов равно количеству параметров модели.
- $\mathbf{b}$ --- вектор из $p$ коэффициентов линейной модели
- $\mathbf{e}$ --- вектор остатков, один столбец в _n_ строк


## Разнообразие методов, основанных на общих линейных моделях

Разнообразие методов во многом определяется устройством модельной матрицы $\textbf{X}$, то есть тем, какова природа предикторов.

- Непрерывные,  дискретные и их взаимодействия -  Общие линейные модели   
- Только непрерывные - Регрессионный анализ    
- Только дискретные - Дисперсионный анализ (ANOVA)     
- Дискретные и непрерывные, без взаимодействия - Анализ ковариации (ANCOVA)    


## Регрессионные модели с непрерывными и дискретными предикторами

Что мы уже о них знаем:

- Принципиальных отличий этой формы линейных моделей от обычной множественной регрессии нет.   
- Дискретные предикторы входят в модель, как переменные-индикаторы (dummy-variable).   
- Между дискретными и непрерывными предикторами может существовать взаимодействие.  
- Наличие взаимодействия необходимо специально оценивать. 
- Визуализация таких моделей включает несколько линий регрессии, соответствующих разным градациям дискретного фактора.


# Analysis of covariance (ANCOVA) --- частный случай общих линейных моделей  {.segue}


## Ковариата

Иногда влияние дискретного фактора зависит от дополнительной непрерывной переменной --- **ковариаты**.

Например, испытывая влияние двух типов удобрений на суммарный урожай на делянках разной площади, мы должны учесть площадь делянки, которую включим в анализ как ковариату.


Площадь делянки --- это ковариата.

Важное ограничение: в ANCOVA ковариата не должна взаимодействовать с дискретным предиктором.





## Емкость легких у разных возрастных групп
Различается ли объем легких  разных возрастных групп пациентов, которых готовят к операции?

Загрузите с сайта данные `tlc.csv` и поместите файл в папку `data` в рабочей директории.

\small{Данные: Altman, 1991 \\  
Источник: пакет \texttt{ISwR}}


## Читаем данные


```{r}
tlc <- read.table('data/tlc.csv', sep = ';', header = TRUE)
str(tlc)
```

Переменные:

- `age` -- возраст.   
- `sex` -- пол (1 - женский; 2 - мужской)
- `height` -- рост (см)
- `tlc`-- объем легких (л)

## Немного преобразуем исходный датасет

```{r}
# Создаем переменную, кодирующую возрастную группу
tlc$age_group[tlc$age < 20] <- 'teenagers'
tlc$age_group[tlc$age < 30 & tlc$age >= 20] <- 'young'
tlc$age_group[tlc$age >= 30] <- 'adult'

# Создаем фактор с удобным порядком градаций
tlc$age_group <- factor(tlc$age_group, levels = c('teenagers', 'young', 'adult'))
```

## Как распределены измерения между группами

```{r}
table(tlc$age_group, tlc$sex)

```

## В фокусе исследования дискретная переменная

Нас интересует, зависит ли объем легких  (`tlc`) от возрастной группы (`age_group`).

То есть модель должна быть основана только на дискретном предикторе с тремя градациями. 

Можно ли построить модель такого вида?

$$
tlc_i = b_0 + b_1 \cdot I_{young\,i} + b_3 \cdot I_{adult\,i} + e_i
$$

то есть модель должна быть основана только на дискретном предикторе с тремя градациями. 

## Нет принципиальной разницы

Моделями с дискретными предикторами занимается **дисперсионный анализ**. С ним мы детально познакомимся позднее.

**НО**! Мы уже знаем, что принципиальной разницы между обычным регрессионным анализом и регрессионным анализом с переменными-индикаторами нет. 


## Модель с дискретным предиктором


```{r}
Mod <- lm(tlc ~ age_group, data = tlc)
summary(Mod)
```



## Трактовка полученных результатов {.smaller}

Фрагмент вывода функции `summary()`

```
Coefficients:
                 Estimate Std. Error t value     Pr(>|t|)
(Intercept)         4.037      0.496    8.13 0.0000000057 ***
age_groupyoung      3.163      0.617    5.13 0.0000178258 ***
age_groupadult      2.055      0.587    3.50       0.0015 **
```

За базовый уровень взято значение `age_group` = `teenagers`.

Коэффициенты модели показывают, что объем легких у `young` и `adult` при попарном сравнении с базовым уровнем статистически значимо выше, чем объем легких у `teenagers`.

Уравнение модели:

$\widehat{tlc}_i = 4.037 + 3.163 \cdot I_{young\,i} + 2.055 \cdot I_{adult\,i}$



# Кодирование дискретных предикторов в R  {.segue}



## Простая регрессионная модель в матричном виде
Мы помним, что  модель $y_i = b_0 + b_1x_i + e_i$ можно записать в матричном виде


$$
\mathbf{y} = \mathbf{X}{\mathbf b} + \mathbf{e}
$$
или 


$$
\widehat{\mathbf{y}} = \mathbf{X}{\mathbf b}
$$

Как устроена модельная матрица $\mathbf{X}$,  если в модели только дискретные предикторы?


## Модельная матрица для моделей с дискретными факторами {.smaller}


```{r}
X <- model.matrix(Mod)
X[c(1:5, 10:15), ]
```


В колонке `(Intercept)` стоят единицы, как в обычной регрессионной модели.   
В колонке `age_groupyoung` записана первая переменная-индикатор.   
1 --- если наблюдение относится к `young`, в остальных случаях --- 0.   
В колонке `age_groupadult` записана вторая переменная-индикатор.   
1 --- если наблюдение относится к `adult`, в остальных случаях --- 0.   
В тех наблюдениях, которые относятся к базовому уровню, везде будет 0.   



## Матричное умножение 

Вектор коэффициентов

```{r}
coef(Mod)
```


Для объекта, относящегося к базовому уровню

```{r}
X[2,]
```

$$
\widehat{tlc} = 1 \cdot 4.04 + 0 \cdot 3.16 + 0 \cdot 2.06 = 4.04 
$$


$$
\widehat{\mathbf{y}} = \mathbf{X}{\mathbf b}
$$


## Матричное умножение 

Вектор коэффициентов

```{r}
coef(Mod)
```


Для объекта, относящегося к `young`

```{r}
X[12,]
```

$$
\widehat{tlc} = 1 \cdot 4.04 + 1 \cdot 3.16 + 0 \cdot 2.06 = 4.04 + 3.16=7.20
$$


$$
\widehat{\mathbf{y}} = \mathbf{X}{\mathbf b}
$$


## Матричное умножение 

Вектор коэффициентов

```{r}
coef(Mod)
```


Для объекта, относящегося к `adult`

```{r}
X[1, ] 
```

$$
\widehat{tlc} = 1 \cdot 4.04 + 0 \cdot 3.16 + 1 \cdot 2.06 = 4.04 + 2.06=6.10
$$


$$
\widehat{\mathbf{y}} = \mathbf{X}{\mathbf b}
$$

# Геометрическая интерпретация линейной модели с дискретным предиктором {.segue}

## Данные для графика предсказаний модели

Это будет график средних значений зависимой переменной для каждой градации дискретного фактора.

```{r}
# Создаем искусственный датасет со всеми возможными значениями предиктора
new_data <- data.frame(age_group = factor(levels(tlc$age_group), 
                                          levels = levels(tlc$age_group)))
# Предсказанные моделью средние значения зависимой перменной
new_data$fit <- predict(Mod, newdata = new_data, se.fit = TRUE)$fit

# Стандартные ошибки
new_data$se <- predict(Mod, newdata = new_data, se.fit = TRUE)$se.fit

# Критические значения t для расчета доверительных интервалов 
t_crit <- qt(0.975, df = nrow(tlc) - length(coef(Mod)))

# Границы доверительных интервалов
new_data$upr <- new_data$fit + t_crit * new_data$se
new_data$lwr <- new_data$fit - t_crit * new_data$se
```



## График предсказаний модели

```{r}
library(ggplot2)
ggplot(new_data, aes(x = age_group, y = fit)) +
  geom_bar(stat = 'identity', aes(fill = age_group)) +
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2) +
  scale_x_discrete(labels = c('Подростки', 'Молодые', 'Взрослые')) +
  guides(fill = 'none') +
  labs(x = 'Возрастная группа', y = 'Объем легких')
```


## Можно ли доверять полученным результатам?

```{r}
Mod_diag <- fortify(Mod) # Создаем датафрейм с диагностическими данными
Mod_diag$height <- tlc$height # Переменная, не вошедшая в модель

ggplot(Mod_diag, aes(x = height, y = .stdresid)) +
  geom_point() + geom_hline(yintercept = 0) +
  geom_smooth(method = 'lm')
```

Виден очевидный паттерн в остатках!


## В модели необходимо учесть ковариату

Изученные пациенты отличались не только возрастом, но и размером тела (`height`).  
Этот параметр может тоже влиять на объем легких.

Необходимо провести ANCOVA.

## Полная модель с учетом ковариаты

```{r}
Mod_cov <- lm(tlc ~ age_group * height, data = tlc)
```

В этой модели мы заложили наличие взаимодействия между дискретным и непрерывным предиктором.

ANCOVA подразумевает отсутствие взаимодействия между дискретным предиктором, который находится в фокусе нашего исследования, и ковариатой.

Нужен тест на наличие взаимодействия.


## Присутствует ли взаимодействие?

```{r}
drop1(Mod_cov, test = 'F')
```

Значимого взаимодействия нет!
Можно делать ANCOVA.

## ANCOVA: модель с учетом ковариаты

Модель в ANCOVA ничем не отличается от любой другой регрессионной модели, включающей непрерывные и дискретные предикторы без их взаимодействия. 

```{r}
Mod_cov_2 <- lm(tlc ~ age_group + height, data = tlc)

```

## Модельная матрица в ANCOVA

```{r}
X <- model.matrix(Mod_cov_2)
head(X)
```

Здесь помимо колонок с переменными-индикаторами (`age_groupyoung` и `age_groupadult`) еще присутствует колонка со значениями непрерывного предиктора (`height`).

Аналогичная модельная матрица будет в любых других регрессионных моделях, включающих непрерывные и дискретные предикторы без их взаимодействия.  

## Матричные умножения в ANCOVA {.smaller}

Вектор коэффициентов

```{r}
coef(Mod_cov_2)
```

Для объекта, относящегося к базовому уровню

```{r}
X[2, ] 
```

$$
\widehat{tlc} = 1 \cdot (-6.9258) + 0 \cdot  1.8991 + 0 \cdot 0.7197 + 0.0718 \cdot 138 = 2.98
$$


$$
\widehat{\mathbf{y}} = \mathbf{X}{\mathbf b}
$$


## Матричные умножения в ANCOVA {.smaller}


Вектор коэффициентов

```{r}
coef(Mod_cov_2)
```

Для объекта, относящегося к `young`

```{r}
X[13, ] 
```

$$
\widehat{tlc} = 1 \cdot (-6.9258) + 1 \cdot  1.8991 + 0 \cdot 0.7197 + 0.0718 \cdot 160 = 6.46
$$


$$
\widehat{\mathbf{y}} = \mathbf{X}{\mathbf b}
$$


## Матричные умножения в ANCOVA {.smaller}


Вектор коэффициентов

```{r}
coef(Mod_cov_2)
```

Для объекта, относящегося к `adult`

```{r}
X[1, ] 
```

$$
\widehat{tlc} = 1 \cdot (-6.9258) + 0 \cdot  1.8991 + 1 \cdot 0.7197 + 0.0718 \cdot 149 = 4.49
$$


$$
\widehat{\mathbf{y}} = \mathbf{X}{\mathbf b}
$$


## Диагностика модели в ANCOVA  {.segue}

Нет ли коллинеарности?

```{r}
library(car)
vif(Mod_cov_2)
```

Коллинеарности нет.


## График остатков

```{r}
# Датафрейм с диагностическими данными
Mod_cov_2_diag <- fortify(Mod_cov_2)

ggplot(Mod_cov_2_diag, aes(x = .fitted, y = .stdresid)) +
  geom_point() + geom_hline(yintercept = 0) +
  geom_smooth(method = 'lm')
```

Есть намек на гетероскедастичность!



## Остатки в зависимости от непрерывного предиктора

```{r}
ggplot(Mod_cov_2_diag, aes(x = height, y = .stdresid)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_smooth(method = 'lm')
```


## Остатки в зависимости от дискретного предиктора

```{r}
ggplot(Mod_cov_2_diag, aes(x = age_group, y = .stdresid)) +
  geom_boxplot() +
  geom_hline(yintercept = 0)

```


## Результаты ANCOVA

```{r}
summary(Mod_cov_2)
```




## Трактовка полученных результатов

Фрагмент вывода функции `summary()`

```
Coefficients:
               Estimate Std. Error t value Pr(>|t|)    
(Intercept)     -6.9258     2.9293   -2.36  0.02523 *  
age_groupyoung   1.8991     0.6107    3.11  0.00427 ** 
age_groupadult   0.7197     0.6011    1.20  0.24124    
height           0.0718     0.0190    3.78  0.00076 ***

```

За базовый уровень взято значение `age_group` = `teenagers`.

Коэффициенты модели показывают, что объем легких у `young` при попарном сравнении с базовым уровнем статистически значимо выше, чем у `teenagers`.

Введение в модель ковариаты помогло избежать ложных выводов!


## Тестируем значимость предикторов

Можем воспользоваться частными F-тестами, чтобы протестировать значимость предикторов в целом.

```{r}
Anova(Mod_cov_2)
```


## Сложности визуализации 

Модель включает помимо дискретного предиктора еще и непрерывную ковариату. 

Предсказания такой модели невозможно представить в виде простой столбчатой диаграммы, отражающей обычные средние значения зависимой переменной для каждой градации фактора.

Необходимо вместо обычных средних использовать **скорректированные средние** (**Adjusted means**).

## Cкорректированные средние {.smaller}
Для их вычисления необходимо принять значение ковариаты за константу (идеально подходит среднее значение ковариаты)

Для их вычисления необходимо принять значение ковариаты за константу (идеально подходит среднее значение ковариаты).

```{r}
# Создаем искусственный датасет со всеми возможными значениями дискретного предиктора 
# и средним значением ковариаты
new_data <- data.frame(age_group = factor(levels(tlc$age_group),
                                          levels = levels(tlc$age_group)), 
                       height = mean(tlc$height))
# Предсказанные моделью скорретированные средние значения зависимой переменной
new_data$fit <- predict(Mod_cov_2, newdata = new_data, se.fit = TRUE)$fit

# Стандартные ошибки
new_data$se <- predict(Mod_cov_2, newdata = new_data, se.fit = TRUE)$se.fit
# t для расчета доверительного интервала 
t_crit <- qt(0.975, df = nrow(tlc) - length(coef(Mod_cov_2))) 
# Границы доверительных интервалов
new_data$upr <- new_data$fit + t_crit * new_data$se
new_data$lwr <- new_data$fit - t_crit * new_data$se
```


## Визуализация модели {.smaller}

```{r}
ggplot(new_data, aes(x = age_group, y = fit)) +
  geom_bar(stat = 'identity', aes(fill = age_group)) +
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2) +
  scale_x_discrete(labels = c('Подростки', 'Молодые', 'Взрослые')) +
  guides(fill = 'none') +
  labs(x = 'Возрастная группа', y = 'Объем легких')
```







## Take home messages

- Нет разницы между моделями с дискретными и непрерывными предикторами
- При анализе влияния дискретного фактора часто необходимо учитывать влияние ковариаты.
- Пр тестировании гипотезы надо помнить о существовании двух типов тестирования: последовательное vs иерархическое.


## Что почитать

+ <span style="color:red">Must read paper!</span> , A.F. and Ieno, E.N., 2016. A protocol for conducting and presenting results of regression‐type analyses. Methods in Ecology and Evolution, 7(6), pp.636-645.

+ Кабаков Р.И. R в действии. Анализ и визуализация данных на языке R. М.: ДМК Пресс, 2014
+ Zuur, A., Ieno, E.N. and Smith, G.M., 2007. Analyzing ecological data. Springer Science & Business Media.
+ Quinn G.P., Keough M.J. 2002. Experimental design and data analysis for biologists
+ Logan M. 2010. Biostatistical Design and Analysis Using R. A Practical Guide

