---
title: "Множественная регрессия"
subtitle: "Линейные модели..."
author: "Марина Варфоломеева, Вадим Хайтов"
output:
  beamer_presentation:
    colortheme: beaver
    highlight: tango
    includes:
      in_header: ./includes/header.tex
    pandoc_args:
    - --latex-engine=xelatex
    - -V fontsize=10pt
    - -V lang=russian
    slide_level: 2
    theme: default
    toc: no
institute: "Кафедра Зоологии беспозвоночных, Биологический факультет, СПбГУ"
---

```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.show='hold', size='footnotesize', comment="#", warning=FALSE, message=FALSE, dev='cairo_pdf', fig.height=2.5, fig.width=7.7)
# library("extrafont")
```


## Множественная регрессия

+ Техника подгонки множественных регрессионных моделей
+ Проверка условий применимости множественных регрессионных моделей 

### Вы сможете

+ Подобрать множественную линейную модель
+ Протестировать ее статистическую значимость и валидность

## Пример: Птицы в лесах Австралии

Фрагментация лесных местообитаний - одна из важнейших проблем Австралии.

Вопрос: от каких факторов зависит обилие птиц во фрагментированных лесных массивах? (Loyn, 1987)

\columnsbegin

\column{0.5\textwidth}

\includegraphics{images/Australia.png}   

\column{0.5\textwidth}

**Зависимая перменная**

- `ABUND` - Обилие птиц на стандартном маршруте

**Предикторы**

- `AREA` - площадь лесного массива (Га)  
- `YRISOL` - год, в котором произошла изоляция лесного массива   
- `DIST` - расстояние до ближайшего лесного массива (км)   
- `LDIST` - расстояние до ближайшего более крупного массива (км)    
- `GRAZE` - качественная оценка уровня выпаса скота (1 - низкий уровень, 5 - высокий уровень)    
- `ALT` - высота над уровнем моря (м)   

\columnsend

\tiny{Пример из кн. Quinn, Keugh, 2002, данные из Loyn, 1987)}

## Скачиваем данные

Не забудьте войти в вашу директорию для матметодов при помощи `setwd()`

```{r eval=FALSE}
# Данные можно загрузить с сайта
library(downloader)
# в рабочем каталоге создаем суб-директорию для данных
if(!dir.exists("data")) dir.create("data")
# скачиваем файл
download(
  url = "https://varmara.github.io/linmodr-course/data/loyn.csv", 
  destfile = "data/loyn.csv")
```

## Читаем данные

```{r}
bird <- read.csv("data/loyn.csv")
```

### Проверяем, все ли правильно открылось

```{r}
str(bird)
```

### Есть ли пропущенные значения?

```{r}
sapply(bird, function(x)sum(is.na(x)))
```


## Можно ли ответить на вопрос таким методом?

```{r}
cor(bird)
```

\pause

Нет

- Обычная корреляция не учитывает, что взаимосвязь между переменными может находиться под контролем других переменых и их взаимодействий.
- Множественные тесты. При тестировании значимости множества коэффициентов корреляции нужно вводить поправку для уровня значимости. Лучше было бы учесть все в одном анализе.

## Нам предстоит построить множественную регрессионную модель

$$y_i = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \beta_3x_{i3} + ... + \beta_px_{ip} + \varepsilon_i$$

- $y_i$ - значение зависимой переменной для $i$-того наблюдения
- $\beta_0$ - свободный член (intercept). Значение $Y$ при $X_1=X_2=X_3=....=X_p=0$  
- $\beta_1$ - частный угловой коэффициент для зависимости $Y$ от $X_1$. Показывает насколько единиц изменяется $Y$ при изменении $X_1$ на одну единицу и при условии, что все остальные предикторы не изменяются.  
$\beta_2$, $\beta_3$, ...., $\beta_p$ - аналогично   
- $\varepsilon_i$ - варьирование $Y$, не объясняемое данной моделью


## Геометрическая интерпретация множественной линейной модели 

### Для случая с одним предиктором $y_i = \beta_0 + \beta_1x_i + \varepsilon_i$ --- линия регрессии

```{r, echo=FALSE, purl=FALSE}
library(ggplot2)
x <- runif(100, 0, 10)
y <- 10*x + 10 + rnorm(100, 0, 50)
qplot (x=x, y=y) + geom_smooth(method = "lm")
```

## Геометрическая интерпретация множественной линейной модели

### Для случая с двумя предикторами $y_i = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \varepsilon_i$ --- плоскость в трехмерном пространстве

```{r, echo=FALSE, fig.height=6, fig.width=6, out.height='5cm', purl=FALSE}
library(plot3D)
with (mtcars, {
  
  # linear regression
   fit <- lm(mpg ~ wt + disp)

  # predict values on regular xy grid
   wt.pred <- seq(1.5, 5.5, length.out = 30)
   disp.pred <- seq(71, 472, length.out = 30)
   xy <- expand.grid(wt = wt.pred, 
                     disp = disp.pred)

   mpg.pred <- matrix (nrow = 30, ncol = 30, 
      data = predict(fit, newdata = data.frame(xy), 
      interval = "prediction"))

# fitted points for droplines to surface
   fitpoints <- predict(fit) 

   scatter3D(z = mpg, x = wt, y = disp, pch = 18, cex = 2, theta = 20, phi = 20, ticktype = "detailed", xlab = "First predictor X1", ylab = "Second predictor X2", zlab = "Response variable",  surf = list(x = wt.pred, y = disp.pred, z = mpg.pred,  facets = NA, fit = fitpoints), main = "")
  
 })

```

## Геометрическая интерпретация множественной линейной модели

### Для случая с большим количеством предикторов 

$$y_i = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \beta_3x_{i3} + ... + \beta_px_{ip} + \varepsilon_i$$

Плоскость в n-мерном пространстве, оси которого образованы значениями предикторов


## Исследование данных (Data Exploration)

```{r fig.height=7, out.height='7cm'}
library(car)
scatterplotMatrix(bird)
```

## Явные проблемы --- есть сильные корреляции между некоторым предикторами

```{r fig.height=7, out.height='8cm', out.width='8cm', echo=FALSE}
scatterplotMatrix(bird)
```

## Задание

- Постройте множественную линейную регрессию для зависимости обилия птиц (`ABUND`) от других переменных (`AREA`, `YRISOL`, `DIST`, `LDIST`, `GRAZE`, `ALT`)

## Решение

\fontsize{10pt}{10pt}

```{r}
mod1 <- lm(ABUND ~  AREA + YRISOL + DIST + LDIST + GRAZE + ALT, data = bird)
mod1 <- lm(ABUND ~  . , data = bird) # то же самое

summary(mod1)
```

# Проверка валидности модели

## Вспомним условия применимости линейных моделей

- Линейная связь между зависимой перменной ($Y$) и предикторами ($X$)
- Независимость значений $Y$ друг от друга
- Нормальное распределение $Y$ для каждого уровня значений $X$
- Гомогенность дисерсий $Y$ для каждого уровня значений $X$
- Отсутствие коллинеарности предикторов (для можественной регрессии)

## Задание

- Проверьте условия применимости модели обилия птиц


## Решение средствами базовой графики

```{r purl=FALSE}
op <- par(mfrow = c(1, 3))
plot(mod1, which = 4)
residualPlot(mod1)
qqPlot(mod1)
par(op)
```

\pause

- Выбросов нет
- Гетерогенность дисперсий
- Отклонения от нормального распределения?

## Решение в `ggplot2`

```{r purl=FALSE}
bird_diag <- fortify(mod1)
# квантильный график
mean_val <- mean(bird_diag$.stdresid)
sd_val <- sd(bird_diag$.stdresid)
gg_qq <- ggplot(bird_diag, aes(sample = .stdresid)) + geom_point(stat = "qq") + geom_abline(intercept = mean_val, slope = sd_val)
# остатки и расстояние Кука
gg_res <- ggplot(data = bird_diag, aes(x = .fitted, y = .stdresid, size = .cooksd)) + geom_point() + geom_hline(aes(yintercept = 0))
# вместе
library(gridExtra)
grid.arrange(gg_qq, gg_res, nrow = 1, widths = c(0.45, 0.55))
```


# Мультиколинеарность

## Мультиколинеарность

Мультиколинеарность ---  наличие линейной зависимости между независимыми переменными (факторами) регрессионной модели.

При наличии мультиколинеарности оценки параметров получаются неточными, а значит сложно будет дать интерпретацию влияния предикторов на отклик

Косвенные признаки мультиколинеарности:

- Большие ошибки оценок параметров             
- Большинство параметров модели недостоверно отличаются от нуля, но F критерий говорит, что вся модель значима

### Проверка на мультиколинеарность

- Фактор инфляции дисперсии (Variance inflation factor, VIF)

## Как рассчитывается VIF

Мы должны оценить какую долю изменчивости конкретного предиктора могут объяснить другие предикторы (т.е. насколько предикторы независимы)

Для каждого предиктора:

1. Строим регрессионную модель данного предиктора от всех остальных
$$x_1 = c_0 + c_2x_2 +c_2x_3 + .... + c_px_p$$
2. Находим $R^2$ модели
3. Вычисляем фактор инфляции дисперсии
$$VIF = \frac{1}{1-R^2}$$

## Что делать, если мультиколинеарность выявлена?

- Можно последовательно удалить из модели избыточные предикторы с VIF > 3 (иногда VIF > 2)
    1. подбираем модель
    2. считаем VIF
    3. удаляем предиктор с самым большим VIF
    4. повторяем 1-3

- Можно заменить исходные предикторы новыми независимыми друго от друга переменными, полученными с помощью метода главных компонент

## Проверяем отсутствие мультиколинеарности

Функция `vif()` из пакета `car`
```{r}
vif(mod1)
```

\pause

В нашей модели явной мультколинеарности нет

Однако, возможно, что  `GRAZE` - избыточный предиктор

## Удалим из модели избыточный предиктор

```{r}
mod2 <- update(mod1, ~ . -GRAZE)
vif(mod2)
```

\pause

Теперь мультиколинеарности нет

## В этой модели осталось много незначимых предикторов

```{r}
coef(summary(mod2))
```

### Что дальше?

Два варианта действий:

- Оставить все как есть. Если значение коэффициента при предикторе не значимо отличается от нуля, значит, этот предиктор не влияет на обилие птиц
- Провести пошаговый подбор оптимальной модели (Об этом на следующей лекции)

Сегодня мы оставим все как есть и попытаемся выяснить, какие предикторы влияют сильнее всего

## Какой из предиктов оказывает наиболее сильное влияние?

Для ответа на этот вопрос надо "уравнять" шкалы, всех предикторов, то есть стандартизовать их. 

Коэффициенты при стандартизованных предикторах покажут, насколько сильно меняется отклик при изменении предиктора на одно стандартное отклонение.

Для стандартизации используем функцию `scale()`

```{r, tidy=TRUE}
mod2_scaled <- lm(ABUND ~ scale(AREA) + scale(YRISOL) + scale(DIST) + scale(LDIST) + scale(ALT), data = bird)
```

## Какой из предиктов оказывает наиболее сильное влияние на усилие дыхательных мышц?

```{r}
coef(summary(mod2_scaled))
```

\pause

- Сильнее всего на обилие птиц влияют продолжительность изоляции и высота, на которой расположен лес
- При изменении продолжительности изоляции на 1 стандартное отклонение, обилие птиц изменяется на `r round(coef(mod2_scaled)[3], 2)`
- При изменении высоты на 1 стандартное отклонение, обилие птиц изменяется на `r round(coef(mod2_scaled)[6], 2)`

## Задание

Постройте модель описывающую связь между усилием мышц, осуществляющих выдох (`pemax`) и следующими переменными:

- `age` - Возраст
- `sex` - Пол (0: male, 1:female)
- `height` - Рост (cm)
- `weight` - Вес (kg)
- `bmp` - Отклонения в весе от нормы (% of normal)
- `fev1` - Объем наполенных легких
- `rv` - Остаточный объем легких
- `frc` - Функциональная остаточная емкость легких
- `tlc` - Общая емкость легких

Исключите из модели колинеарные предикторы.

Для получения данных выполните следующий код:

```{r}
library(ISwR)
data(cystfibr)
```

## Решение

\fontsize{10pt}{10pt}

```{r purl=FALSE}
M1 <- lm(pemax ~ ., data = cystfibr)
summary(M1)
```

## Проверяем на колинеарность

```{r purl=FALSE}
vif(M1)
```

### Удаляем избыточные предикторы

```{r purl=FALSE}
M2 <- update(M1, .~.-weight)
vif(M2)
```


## Продолжаем удалять избыточные предикторы

```{r purl=FALSE}
M3 <- update(M2, . ~. - frc)
vif(M3)
```

### Продолжаем удалять избыточные предикторы

```{r purl=FALSE}
M4 <- update(M3, . ~. - height)
vif(M4)
```

### Наконец-то колинеарности нет

## Смотрим на полученную модель

\fontsize{10pt}{10pt}

```{r purl=FALSE}
summary(M4)
```

# Взаимодействия предикторов

## Взаимодействие предикторов

В регрессионные модели можно включать не только предикторы сами по себе, но и их взаимодействия. 

Взаимодействие предикторов показывает, что угловой коэффициент одного предиктора зависит от значения другого предиктора.

Переменные, участвующие во взаимодействиях, иногда называют переменными-модераторами --- они регулируют связь между предиктором и откликом.

Модели, в которых есть достоверное взаимодействие непрерывных предикторов сложно интерпретировать. 

Для визуализации взаимодействия можно построить график отклика при нескольких значениях предиктора (например, при среднем значении модератора или $\pm 1 \cdot SD$)


## Вернемся к данным по обилию птиц и построим модель для двух предикторов

Формулу модели со взаимодействием можно записать двумя способами

- ABUND ~ YRISOL + GRAZE + YRISOL:GRAZE
- ABUND ~ YRISOL * GRAZE

\fontsize{10pt}{10pt}

```{r}
mod3 <- lm(ABUND ~ YRISOL * GRAZE, data = bird)
summary(mod3)
```

## Как интерпретировать взаимодействия?

График отклика при нескольких значениях предиктора

```{r interact-plot, echo=FALSE, fig.height=4}
MyData <- expand.grid(YRISOL = seq(1890, 1976, 1),
                      GRAZE = seq(1, 5, 1)) 
MyData$Predicted <- predict(mod3, newdata = MyData)
ggplot(MyData, aes(x = YRISOL,  y = Predicted, group = GRAZE)) + 
  geom_line(aes(color = GRAZE), size = 2) + 
  geom_point(data = bird, aes(x = YRISOL, y = ABUND, color = GRAZE), size = 4) + 
  scale_colour_continuous(low = "yellow", high = "red") + 
  xlab ("Год изоляции") + ylab("Обилие птиц")
```

НО! Не всегда все так просто трактуется...   

Часто трактовка взаимодействий затруднительна, особенно если предкторов много.


## График на предыдущем слайде получен с помощью кода

```{r interact-plot, eval=FALSE, purl=FALSE}
```


## Include or Don't include? That is the question...

Вопрос о включении в модель взаимоодействия предикторов совсем непростой

Существует несколько подходов:

1. Не включать взаимодействия в модель. Но если при валидации модели в остатках появляется явный паттерн, то это может быть следствием наличия взаимодействия предикторов
2. Основываясь на априорных знаниях свойств объектов включить только те взаимоотношения, которые имеют биологический смысл, либо взаимодействия с наиболее важными переменными (теми, ради которых была затеяна работа)
3. Включать в модель все взаимодействия, потом пошагово выбросить недостоверные (Model selection - на следующей лекции)

\pause

Включать в анализ и обсуждать все взаимодействия "дорого" (неудобно):

- Взаимодействия высоких порядков сложно интерпретировать
- Каждое взаимодействие --- это коэффициент в модели, или несколько, если это взаимодействие с дискретной переменной. Чтобы подобрать модель нужно много данных --- по 20-40 наблюдений в расчете на каждый коэффициент.


## Summary

- При построении множественной регрессии важно, помимо других условий, проверить модель на наличие мультиколинеарности
- Если модель построена на основе стандартизированных значений предикторов, то можно сравнивать влияние этих предикторов
- В модель можно (а иногда и нужно) включать взаимодействия предикторов

## Что почитать

+ Кабаков Р.И. R в действии. Анализ и визуализация данных на языке R. М.: ДМК Пресс, 2014.
+ Quinn G.P., Keough M.J. (2002) Experimental design and data analysis for biologists, pp. 92-98, 111-130
+ Diez D. M., Barr C. D., Cetinkaya-Rundel M. (2014) Open Intro to Statistics., pp. 354-367.
+ Logan M. (2010) Biostatistical Design and Analysis Using R. A Practical Guide, pp. 170-173, 208-211
+ Zuur, A.F. et al. 2009. Mixed effects models and extensions in ecology with R. - Statistics for biology and health. Springer, New York, NY. pp. 538-552.

